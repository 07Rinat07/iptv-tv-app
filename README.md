# myscanerIPTV для Android TV Box

Production-oriented MVP IPTV-приложения для Android TV/TV Box (minSdk 24).
Для энтузиастов, желающих быстро найти и смотреть IPTV-каналы с помощью удобного интерфейса и встроенного плеера.

## Текущий статус ===> Приложение в РАЗРАБОТКЕ
Обновлено: `23.02.2026 (12:12)`.
- Приложение запускается без PIN-кода.
- Работают ключевые сценарии:
  - `Сканировать -> Найти -> Сохранить -> Мои плейлисты -> Редактор -> Воспроизвести`.
- Поддержано управление и D-pad/пультом, и мышью.
- Улучшен TV-фокус: убран перехват фокуса корневыми списками, стартовый фокус в шапке на кнопке `Разделы`.

### Последнее обновление (этот билд)
- Доработан экран плеера: фильтры по `группам` и `подгруппам` каналов.
- Выбор канала в быстром и полном списке теперь сразу запускает встроенный плеер.
- Каталог каналов в плеере раскрыт по умолчанию.
- Добавлены логотипы каналов в быстром списке и в полном каталоге (где логотип доступен в плейлисте).


## Что уже реализовано
- Многомодульная архитектура: Clean Architecture + MVVM + Hilt + Room + WorkManager.
- Сканер публичных M3U/M3U8:
  - GitHub/GitLab/Bitbucket;
  - переключатель режима поиска: `Auto / Direct API / Search Engine`;
  - ручной прокси для сканера: `host/port/user/pass`;
  - fallback через поисковики (DuckDuckGo/Bing) для обхода блокировок прямого API;
  - пресеты поиска (общий, русские, мир, спорт, фильмы, Voxlist/Repo);
  - AI-режим сканера (улучшенная генерация дополнительных вариантов запроса под GitHub/GitLab);
  - автообучение AI-поиска: сохранение успешных query-шаблонов в DataStore и автоподмешивание в следующие сканы;
  - пошаговый прогресс поиска (шаг/провайдер/сколько найдено/время выполнения);
  - ручная остановка поиска с сохранением уже найденного;
  - отдельный явный этап `Сохранение найденного` с прогрессом `X/Y` (видно, что после 5 минут идет именно сохранение, а не «зависание»);
  - при нажатии `Остановить` во время сохранения импорт останавливается после текущей пачки/файла (без долгого зависания);
  - экспорт найденных в сканере ссылок в `TXT` (имя списка + URL + источник);
  - автоэкспорт найденных ссылок в TXT после `автосохранения` и после `ручной остановки с сохранением`;
  - формат имени TXT: `Tv_list_<поисковый_запрос>_YYYYMMDD_HHMMSS.txt`;
  - fail-fast при проблемах DNS/сети (без «молчаливого» долгого цикла по всем шагам);
  - жесткий таймаут шага поиска + быстрый network-probe (чтобы сканер не зависал на одном шаге минутами);
  - адаптивный backoff провайдера: после повторных таймаутов (например, GitHub) провайдер временно пропускается, чтобы не терять время поиска;
  - явные шаги `Только GitHub/GitLab` и `AI-fallback GitHub/GitLab` больше не блокируются backoff-ом полностью (делается принудительная попытка);
  - health score провайдеров (`GitHub/GitLab/Bitbucket`) с отображением в UI;
  - динамический порядок опроса провайдеров по health score (более стабильные идут первыми);
  - видимый статус backoff в UI (осталось секунд до повторного включения провайдера);
  - расширенный web-fallback: кроме ссылок из GitHub/GitLab/Bitbucket, извлекаются прямые `m3u/m3u8` URL с открытых страниц поисковой выдачи;
  - фильтры `repo/path/date/size`;
  - сохранение всего найденного за запуск (без лимита 10), включая авто-сохранение при лимите 5 минут и при ручной остановке;
  - ускоренный импорт найденного (пакетная обработка, параллельные импорты, таймаут на один импорт);
  - retry/backoff, кэш, логи ошибок и шагов поиска.
- Импорт плейлистов:
  - по URL;
  - вставкой текста;
  - из локального файла;
  - валидация `#EXTM3U/#EXTINF/URL`, дедупликация, health-check потоков;
  - увеличенный лимит ожидания импорта для крупных файлов (`до 300с`).
- Мои плейлисты:
  - хранение источников и каналов;
  - ручное обновление и автообновление через WorkManager.
- Редактор:
  - безопасный Copy-on-Write (оригинал источника не портится);
  - массовые операции: скрыть/показать/удалить/переместить;
  - редактирование полей канала;
  - создание пользовательского плейлиста;
  - экспорт в `M3U/M3U8` (в память приложения и через системный выбор пути);
  - экспорт в `TXT` всех плейлистов с названиями списков и каналов.
- Плеер:
  - встроенный Media3/ExoPlayer;
  - встроенный плеер отображается всегда (даже до старта воспроизведения);
  - двойной клик ЛКМ по встроенному плееру переключает размер `малый/большой`;
  - кнопка `Развернуть/Свернуть` доступна прямо поверх видео/плейсхолдера;
  - внешний VLC:
    - прямой запуск в `VideoPlayerActivity` VLC (fullscreen-сценарий);
    - fallback в совместимый `ACTION_VIEW`, если direct-режим не поддержан устройством/версией VLC;
  - fallback и авто-переключение при ошибках;
  - счетчики на экране плеера (плейлисты/каналы/избранное/по фильтру);
  - компактный интерфейс: основные панели (`Действия`, `Тест URL`, `Тех.инфо`) сворачиваются/разворачиваются;
  - двухпанельный режим на широком экране: видео + быстрый прокручиваемый список каналов рядом;
  - быстрый список каналов рядом с плеером вынесен отдельно от полного каталога (полный каталог раскрывается отдельной кнопкой);
  - быстрый запуск из списка: выбор канала (кнопка/OK) сразу переключает канал и запускает встроенный плеер;
  - фильтрация по группам и подгруппам каналов прямо в плеере;
  - отображение логотипов каналов в быстром списке и карточках каталога;
  - сворачиваемые секции (`Тех.инфо`, `Плейлисты`, `Каналы`) для более чистого интерфейса просмотра;
  - тест URL потока (проверка DNS/HTTP/content-type до воспроизведения);
  - расширенная диагностика `Source error` (категории `dns/http/codec/timeout/...` в логах);
  - профили буфера + ручные параметры;
  - поддержка URL с заголовками вида `url|user-agent=...&referer=...`.
  - EPG мастер: URL источника EPG для выбранного плейлиста (`подставить -> проверить -> сохранить`, с откатом на прошлый URL при провале теста);
  - защита от спама повторяющихся EPG-ошибок в UI и в логах (cooldown для повторов, включая `EPG source URL is not configured`).
- Engine Stream / torrent-TV:
  - подключение к endpoint движка;
  - резолв `magnet/acestream/ace/.torrent` через движок;
  - диагностика статуса движка/сети.
- Глобальное избранное и история просмотров.
- Диагностика и логи:
  - просмотр последних событий в приложении;
  - экспорт логов в файл.
- Отдельный экран `Сетевой тест`:
  - проверка DNS+HTTP до `GitHub/GitLab/Bitbucket/DuckDuckGo/Bing`;
  - учет текущих proxy-настроек сканера;
  - рекомендация режима сканирования (`Auto` / `Direct API` / `Search Engine`);
  - детальные `network_test_*` логи по каждому хосту.

## Ограничения текущего MVP
- Доступность каналов зависит от внешних источников (часть URL может быть “мертвой”).
- Загрузки torrent-задач пока базовые (очередь/статусы/progress-модель без полноценного torrent-клиента).
- Полноценный EPG/телепрограмма и автоподбор/расширенный каталог логотипов пока не финализированы.

## Технический стек
- Kotlin, Coroutines/Flow
- Jetpack Compose (Android TV UI)
- Media3/ExoPlayer
- Retrofit + OkHttp
- Room
- WorkManager
- Hilt

## Требования к окружению
- Android Studio (желательно актуальная версия)
- Android SDK 35
- JDK 17+ (рекомендуется JBR из Android Studio)

## Сборка и тесты (Windows PowerShell)
```powershell
$env:JAVA_HOME="C:\Program Files\Android\Android Studio\jbr"
.\gradlew.bat :feature:scanner:compileDebugKotlin :feature:settings:compileDebugKotlin -x test
.\gradlew.bat testDebugUnitTest -x lint
.\gradlew.bat :app:assembleDebug -x lint
```

## Готовый APK для установки на TV Box
- Локальный debug APK после сборки:
  - `app/build/outputs/apk/debug/app-debug.apk`
- Текущая сборка для проверки (рекомендуется):
  - `build-artifacts/myscanerIPTV-tvbox-debug-latest.apk`
- Фиксированная копия этой же сборки:
  - `build-artifacts/myscanerIPTV-tvbox-debug-20260223-121242.apk`
- Также сохраняются версии с таймстампом:
  - `build-artifacts/myscanerIPTV-tvbox-debug-YYYYMMDD-HHMMSS.apk`

## Установка на Android TV Box через USB
1. Скопируйте на флешку любой из файлов:
   - `app/build/outputs/apk/debug/app-debug.apk` (прямо после локальной сборки);
   - или один из `build-artifacts/*.apk` (рекомендуется `myscanerIPTV-tvbox-debug-latest.apk`).
2. Подключите флешку к TV Box.
3. Откройте любой файловый менеджер на TV Box.
4. Запустите APK и подтвердите установку.
5. Если нужно, включите разрешение “Установка из неизвестных источников” для файлового менеджера.

## Быстрый сценарий использования
1. На главной откройте `Сканер`.
2. В `Настройки` при необходимости включите `AI-сканер`.
3. Если есть проблемы с доступом к GitHub/GitLab, в `Настройки` задайте ручной прокси для сканера (`host/port`, при необходимости `user/pass`) и нажмите `Сохранить прокси`.
4. Выберите пресет (например, `Русские каналы`) и нажмите `Найти и сохранить найденное`.
5. Следите за статусом: текущий шаг, провайдер, сколько найдено, сколько прошло времени.
6. Если сканер не дает результат, откройте `Настройки -> Сетевой тест` и проверьте DNS/API/Web.
7. Если ждать долго, нажмите `Остановить и сохранить найденное`.
8. Перейдите в `Мои плейлисты`, выберите найденный список.
9. Откройте `Редактор` для чистки/сортировки/экспорта.
10. Откройте `Плеер`, выберите плейлист/группу/подгруппу и канал (запуск встроенного плеера происходит сразу при выборе канала).
11. При torrent/ace потоке проверьте endpoint Engine в `Настройки`/`Диагностика`.
12. Для VLC используйте кнопку `Воспроизвести во VLC (fullscreen)`; возврат в приложение — кнопкой `Назад` на пульте.

## Режимы поиска в сканере
- `Auto` (по умолчанию):
  - сначала прямой поиск через API GitHub/GitLab/Bitbucket;
  - если результатов мало/нет, добавляется поиск через DuckDuckGo/Bing.
- `Direct API`:
  - только прямые API провайдеров репозиториев;
  - быстрее на хорошей сети, но чувствителен к DNS/блокировкам.
- `Search Engine`:
  - поиск через поисковые системы с последующим извлечением ссылок;
  - полезен, когда прямой API недоступен или фильтруется.

Рекомендуемый порядок на TV Box:
1. Начните с `Auto`.
2. Если в логах `UnknownHostException`/`Network IO error` — переключитесь на `Search Engine`.
3. Если сеть стабильна и нужен более быстрый точный поиск — используйте `Direct API`.
4. Если API/Search Engine не проходят из-за DNS/фильтрации провайдера — включите ручной прокси сканера в `Настройки`.

## Обучение AI-помощника сканера
- Подробный гайд: `docs/ai-agent-training-ru.md`.
- Скрипт для подготовки обучающего датасета из экспортированных логов:
  - `tools/ai/build_scanner_training_dataset.py`

Пример запуска:
```powershell
python tools/ai/build_scanner_training_dataset.py --input "D:\myscanerIPTV-logs-1771438297065.txt"
```

Скрипт создаёт:
- `tools/ai/training_dataset.jsonl` (попытки поиска с label success/failed/empty);
- `tools/ai/training_summary.md` (успешные запросы и частые причины ошибок).

## Ручной прокси сканера
- Где: `Настройки` -> блок `Прокси для сканера`.
- Поля: `Host`, `Port`, `Username` (опционально), `Password` (опционально).
- После ввода обязательно нажмите `Сохранить прокси`.
- Поддерживается HTTP/HTTPS proxy на уровне сетевого клиента сканера (`SOCKS` в MVP не поддерживается).
- В логе `scanner_start` выводится краткий статус прокси (`proxy=off` или `proxy=on(host:port, user=...)`), чтобы сразу понимать, применились ли настройки.

## Быстрый тест прокси на TV Box
1. В `Настройки` включите прокси, заполните `Host` и `Port`, нажмите `Сохранить прокси`.
2. Откройте `Сканер`, выберите запрос `iptv`, режим `Auto` и нажмите `Найти и сохранить найденное`.
3. В `Диагностика` проверьте:
   - есть `scanner_start` с `proxy=on(host:port, ...)`;
   - нет повторяющихся `UnknownHostException`/`Timeout` для `api.github.com` и `gitlab.com`.
4. Если ошибки остались:
   - проверьте, что прокси доступен с самого TV Box;
   - попробуйте другой прокси или временно `Search Engine` режим.

## Сетевой тест сканера (новое)
- Где: `Настройки` -> `Сетевой тест сканера`.
- Кнопка `Проверить сеть` запускает проверку:
  - DNS-резолв + HTTP-доступ для `api.github.com`, `gitlab.com`, `api.bitbucket.org`, `duckduckgo.com`, `www.bing.com`.
- Что показывает:
  - по каждому хосту: `DNS OK/FAIL`, `HTTP OK/FAIL`, код ответа, время;
  - итоговую рекомендацию режима поиска;
  - текущий proxy-статус (`off` / `on(host:port, user=...)`).
- Логи:
  - `network_test_start`, `network_test_item`, `network_test_finish`, `network_test_error`.
- Если все хосты в `UnknownHostException`:
  - это внешняя проблема сети/DNS на TV Box или роутере, а не логика фильтров сканера;
  - проверьте DNS на устройстве/роутере, VPN/блокировки провайдера, прокси.

## Экспорт и пути файлов
- Экспорт M3U/M3U8:
  - кнопки `Экспорт M3U` / `Экспорт M3U8`;
  - далее `Сохранить как...` (рекомендуется: вы сами выбираете путь) или `Сохранить в память ТВ`.
- Экспорт TXT:
  - кнопка `Экспорт TXT (все списки)` собирает все плейлисты с названиями и каналами в один текст;
  - для TXT используется формат имени: `Tv_list_<поисковый_запрос>_YYYYMMDD_HHMMSS.txt` (сканер) и `Tv_list_YYYYMMDD_HHMMSS.txt` (редактор);
  - при `Найти и сохранить` TXT из сканера формируется автоматически после сохранения найденного;
  - также доступен ручной экспорт найденных ссылок из сканера;
  - сохраняется в общую папку `Download` (`/storage/emulated/0/Download`) через MediaStore или через `Сохранить как...`.
- Экспорт логов:
  - кнопка `Экспорт логов как...` (через системный выбор пути);
  - или автоэкспорт в общую папку `Download` (`/storage/emulated/0/Download`).

## Диагностика: если сканер/импорт не работает
- `scanner_step_error` + `Network IO error`:
  - проверьте интернет на ТВ боксе, DNS, дату/время устройства;
  - повторите с провайдером `GitHub` или `GitLab` отдельно;
  - уберите фильтры `repo/path/size/date`, оставьте простой запрос `iptv`.
- `scanner_preflight_warn`:
  - это предупреждение (не блокировка старта поиска);
  - сканер продолжит работу в деградированном режиме с короткими шагами, чтобы быстро показать причину.
- `scanner_plan_degraded`:
  - сеть ограничена, поэтому план поиска сокращен и таймауты уменьшены;
  - помогает избежать зависания на 1 шаге при DNS/прокси проблемах.
- `scanner_fail_fast`:
  - сканер обнаружил повторяющиеся DNS/timeout ошибки и завершил поиск раньше, чтобы не ждать долго;
  - проверьте DNS в сети ТВ-бокса (например, `1.1.1.1`/`8.8.8.8`), VPN/роутер-фильтры и повторите.
- `scanner_timeout`:
  - источники долго отвечают; используйте `Остановить и сохранить найденное` или повторите позже.
- `scanner_step_error` + `UnknownHostException`:
  - проблема DNS/резолва домена на стороне TV Box/роутера;
  - переключите режим поиска на `Search Engine` и повторите.
- `network_test_finish` с `apiReachable=false, webReachable=false`:
  - приложение не видит DNS/API/Web из текущей сети;
  - исправьте сеть/DNS/прокси и повторите тест, затем запуск сканера.
- повторяющиеся `Timeout`/`UnknownHostException` на `api.github.com`/`gitlab.com`:
  - задайте ручной прокси в `Настройки` и повторите поиск;
  - проверьте, что в `scanner_start` виден `proxy=on(...)`.
- `scanner_no_results_diagnostic`:
  - расширенный лог причины нулевого результата (`dns_unavailable`/`network_timeout`/`rate_limit`/`provider_error_or_no_matches`) + снимок сети по хостам.
- `import_failed | Missing #EXTM3U header`:
  - файл не является корректным M3U/M3U8 (или это HTML/README вместо плейлиста).
- `player_error | Source error`:
  - поток недоступен или блокируется;
  - попробуйте VLC, другой канал, другой профиль буфера.
- `player_error_detail` и `player_stream_probe_*`:
  - детальная причина сбоя плеера и результат проверки URL потока (HTTP/DNS/таймаут/тип контента).
- `player_external_launch_mode`:
  - показывает фактический режим запуска VLC:
    - `mode=direct` — прямой fullscreen-сценарий;
    - `mode=compat` — запуск через совместимый fallback.
- `player_external_direct_error`:
  - direct-запуск VLC не удался, автоматически включен compat fallback.
- `engine_connect_error`:
  - Engine Stream недоступен по указанному endpoint (проверьте порт/доступность движка).

## Примечание по fullscreen во VLC
- VLC является внешним приложением, поэтому часть UI-управления fullscreen выполняется самим VLC.
- Со стороны `myscanerIPTV` реализован приоритетный fullscreen-запуск и автоматический fallback для совместимости.

## Логи и поддержка
- В разделе `Диагностика` доступны последние события (`scanner_*`, `import_*`, `player_*`, `engine_*`).
- Для анализа экспортируйте лог через `Экспорт логов как...` и приложите файл при обращении.

## Разрешения приложения
- `INTERNET`
- `ACCESS_NETWORK_STATE`

## Безопасность и комплаенс
Приложение не содержит механизмов обхода DRM/взлома/скрытия следов.
Используйте только контент, на который у вас есть законные права.

## Лицензия и права использования
© 2026 Rinat Sarmuldin. All rights reserved.

Репозиторий распространяется по проприетарной лицензии: `LICENSE`.

Без письменного разрешения автора запрещены:
- использование в production и коммерческих проектах;
- копирование, изменение, распространение и создание производных работ.

Для получения прав на использование свяжитесь с автором: `ura07srr@gmail.com`.
